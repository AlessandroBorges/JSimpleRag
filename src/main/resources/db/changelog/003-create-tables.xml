<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
                   xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                   xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
                   http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-4.3.xsd">

    <changeSet id="003-001-create-library-table" author="jsimplerag">
        <createTable tableName="library">
            <column name="id" type="SERIAL">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="uuid" type="UUID">
                <constraints nullable="false" unique="true"/>
            </column>
            <column name="nome" type="VARCHAR(255)">
                <constraints nullable="false"/>
            </column>
            <column name="area_conhecimento" type="VARCHAR(255)">
                <constraints nullable="false"/>
            </column>
            <column name="peso_semantico" type="DECIMAL(3,2)" defaultValue="0.60">
                <constraints nullable="false"/>
            </column>
            <column name="peso_textual" type="DECIMAL(3,2)" defaultValue="0.40">
                <constraints nullable="false"/>
            </column>
            <column name="tipo" type="tipo_biblioteca">
                <constraints nullable="false"/>
            </column>
            <column name="metadados" type="JSONB"/>
            <column name="created_at" type="TIMESTAMP" defaultValueComputed="CURRENT_TIMESTAMP"/>
            <column name="updated_at" type="TIMESTAMP" defaultValueComputed="CURRENT_TIMESTAMP"/>
        </createTable>

        <!-- Check constraints -->
        <sql>
            ALTER TABLE library ADD CONSTRAINT peso_semantico_range_check CHECK (peso_semantico BETWEEN 0 AND 1);
            ALTER TABLE library ADD CONSTRAINT peso_textual_range_check CHECK (peso_textual BETWEEN 0 AND 1);
            ALTER TABLE library ADD CONSTRAINT peso_total_check CHECK (peso_semantico + peso_textual = 1.0);
        </sql>

        <rollback>
            DROP TABLE IF EXISTS library;
        </rollback>
    </changeSet>

    <changeSet id="003-002-create-documento-table" author="jsimplerag">
        <createTable tableName="documento">
            <column name="id" type="SERIAL">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="biblioteca_id" type="INT">
                <constraints nullable="false"/>
            </column>
            <column name="titulo" type="VARCHAR(500)">
                <constraints nullable="false"/>
            </column>
            <column name="conteudo_markdown" type="TEXT">
                <constraints nullable="false"/>
            </column>
            <column name="flag_vigente" type="BOOLEAN" defaultValue="true"/>
            <column name="data_publicacao" type="DATE">
                <constraints nullable="false"/>
            </column>
            <column name="tokens_total" type="INTEGER"/>
            <column name="metadados" type="JSONB"/>
            <column name="created_at" type="TIMESTAMP" defaultValueComputed="CURRENT_TIMESTAMP"/>
            <column name="updated_at" type="TIMESTAMP" defaultValueComputed="CURRENT_TIMESTAMP"/>
        </createTable>

        <!-- Foreign Key -->
        <addForeignKeyConstraint
            baseTableName="documento"
            baseColumnNames="biblioteca_id"
            constraintName="fk_documento_library"
            referencedTableName="library"
            referencedColumnNames="id"
            onDelete="CASCADE"/>

        <rollback>
            DROP TABLE IF EXISTS documento;
        </rollback>
    </changeSet>

    <changeSet id="003-003-create-chapter-table" author="jsimplerag">
        <createTable tableName="chapter">
            <column name="id" type="SERIAL">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="documento_id" type="INT">
                <constraints nullable="false"/>
            </column>
            <column name="titulo" type="VARCHAR(500)">
                <constraints nullable="false"/>
            </column>
            <column name="conteudo" type="TEXT">
                <constraints nullable="false"/>
            </column>
            <column name="ordem_doc" type="INTEGER">
                <constraints nullable="false"/>
            </column>
            <column name="token_inicio" type="INTEGER"/>
            <column name="token_fim" type="INTEGER"/>
            <column name="metadados" type="JSONB"/>
            <column name="created_at" type="TIMESTAMP" defaultValueComputed="CURRENT_TIMESTAMP"/>
            <column name="updated_at" type="TIMESTAMP" defaultValueComputed="CURRENT_TIMESTAMP"/>
        </createTable>

        <!-- Foreign Key -->
        <addForeignKeyConstraint
            baseTableName="chapter"
            baseColumnNames="documento_id"
            constraintName="fk_chapter_documento"
            referencedTableName="documento"
            referencedColumnNames="id"
            onDelete="CASCADE"/>

        <!-- Unique constraint -->
        <addUniqueConstraint
            tableName="chapter"
            columnNames="documento_id, ordem_doc"
            constraintName="unique_ordem_por_doc"/>

        <rollback>
            DROP TABLE IF EXISTS chapter;
        </rollback>
    </changeSet>

    <changeSet id="003-004-create-doc-embedding-table" author="jsimplerag">
        <sql>
            CREATE TABLE doc_embedding (
                id SERIAL PRIMARY KEY,
                library_id INT NOT NULL,
                documento_id INT NOT NULL,
                chapter_id INT,
                tipo_embedding tipo_embedding NOT NULL,
                texto TEXT,
                order_chapter INTEGER,
                embedding_vector vector(768) NULL,
                text_search_tsv tsvector GENERATED ALWAYS AS (
				    setweight(to_tsvector('portuguese', COALESCE(metadados->>'nome', '')), 'A') ||         -- Título ou nome da obra
				    setweight(to_tsvector('portuguese', COALESCE(metadados->>'capitulo', '')), 'A') ||     -- Nome do capítulo
				    setweight(to_tsvector('portuguese', COALESCE(metadados->>'descricao', '')), 'B') ||    -- Descrição geral
				    setweight(to_tsvector('portuguese', COALESCE(metadados->>'area_conhecimento', '')), 'C') || -- Área temática
				    setweight(to_tsvector('portuguese', COALESCE(metadados->>'palavras_chave', '')), 'C') ||   -- Palavras-chave
				    setweight(to_tsvector('portuguese', COALESCE(metadados->>'autor', '')), 'D') ||        -- Autor (menos relevante para conteúdo)
				    setweight(to_tsvector('portuguese', COALESCE(metadados->>'metadados', '')), 'D') ||    -- Outros metadados
				    setweight(to_tsvector('portuguese', COALESCE(texto, '')), 'C')                  -- Texto completo do chunk (CORRIGIDO)
				) STORED,               
                metadados JSONB,
                created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,

                -- Foreign Key Constraints
                CONSTRAINT fk_embedding_library FOREIGN KEY (library_id) REFERENCES library(id) ON DELETE CASCADE,
                CONSTRAINT fk_embedding_documento FOREIGN KEY (documento_id) REFERENCES documento(id) ON DELETE CASCADE,
                CONSTRAINT fk_embedding_chapter FOREIGN KEY (chapter_id) REFERENCES chapter(id) ON DELETE CASCADE
            );
        </sql>

        <rollback>
            DROP TABLE IF EXISTS doc_embedding;
        </rollback>
    </changeSet>

</databaseChangeLog>