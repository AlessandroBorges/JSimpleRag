<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
                   xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                   xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
                   http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-4.3.xsd">

    <!-- Library Indexes -->
    <changeSet id="004-001-create-library-indexes" author="jsimplerag">
        <createIndex tableName="library" indexName="idx_library_area">
            <column name="area_conhecimento"/>
        </createIndex>
        <createIndex tableName="library" indexName="idx_library_tipo">
            <column name="tipo"/>
        </createIndex>
        <rollback>
            DROP INDEX IF EXISTS idx_library_area;
            DROP INDEX IF EXISTS idx_library_tipo;
        </rollback>
    </changeSet>

    <!-- Documento Indexes -->
    <changeSet id="004-002-create-documento-indexes" author="jsimplerag">
        <createIndex tableName="documento" indexName="idx_documento_vigente">
            <column name="flag_vigente"/>
            <column name="data_publicacao" descending="true"/>
        </createIndex>

        <createIndex tableName="documento" indexName="idx_documento_biblioteca">
            <column name="biblioteca_id"/>
        </createIndex>

        <!-- Partial index for active documents only -->
        <sql>
            CREATE INDEX idx_documento_vigente_only ON documento(biblioteca_id, data_publicacao DESC)
            WHERE flag_vigente = true;
        </sql>

        <rollback>
            DROP INDEX IF EXISTS idx_documento_vigente;
            DROP INDEX IF EXISTS idx_documento_biblioteca;
            DROP INDEX IF EXISTS idx_documento_vigente_only;
        </rollback>
    </changeSet>

    <!-- Chapter Indexes -->
    <changeSet id="004-003-create-chapter-indexes" author="jsimplerag">
        <createIndex tableName="chapter" indexName="idx_chapter_documento_ordem">
            <column name="documento_id"/>
            <column name="ordem_doc"/>
        </createIndex>
        <rollback>
            DROP INDEX IF EXISTS idx_chapter_documento_ordem;
        </rollback>
    </changeSet>

    <!-- DocEmbedding Indexes -->
    <changeSet id="004-004-create-doc-embedding-indexes" author="jsimplerag">
        <createIndex tableName="doc_embedding" indexName="idx_embedding_library">
            <column name="library_id"/>
        </createIndex>

        <createIndex tableName="doc_embedding" indexName="idx_embedding_documento">
            <column name="documento_id"/>
        </createIndex>

        <createIndex tableName="doc_embedding" indexName="idx_embedding_chapter">
            <column name="chapter_id"/>
        </createIndex>

        <createIndex tableName="doc_embedding" indexName="idx_embedding_tipo">
            <column name="tipo_embedding"/>
        </createIndex>

        <rollback>
            DROP INDEX IF EXISTS idx_embedding_library;
            DROP INDEX IF EXISTS idx_embedding_documento;
            DROP INDEX IF EXISTS idx_embedding_chapter;
            DROP INDEX IF EXISTS idx_embedding_tipo;
        </rollback>
    </changeSet>

    <!-- Vector and Full-Text Search Indexes -->
    <changeSet id="004-005-create-vector-indexes" author="jsimplerag">
        <sql>
            -- Vector similarity index (IVFFlat for approximate nearest neighbor)
            CREATE INDEX idx_embedding_vector ON doc_embedding
            USING ivfflat (embedding_vector vector_cosine_ops)
            WITH (lists = 100);

            -- Full-text search index for text_search_tsv (generated column)
            CREATE INDEX idx_text_search_tsv ON doc_embedding
            USING gin(text_search_tsv);

            -- Composite index for hybrid search optimization
            CREATE INDEX idx_embedding_tipo_library ON doc_embedding(library_id, tipo_embedding);
        </sql>

        <rollback>
            DROP INDEX IF EXISTS idx_embedding_vector;
            DROP INDEX IF EXISTS idx_text_search_tsv;
            DROP INDEX IF EXISTS idx_embedding_tipo_library;
        </rollback>
    </changeSet>

</databaseChangeLog>