<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
                   xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                   xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
                   http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-4.3.xsd">

    <changeSet id="014-001-add-biblioteca-id-to-chapter" author="jsimplerag">
        <comment>
            Add biblioteca_id column to chapter table to maintain consistency in the hierarchy.
            This fixes the modeling gap where chapter didn't have direct reference to library.
            Hierarchy: library -> documento -> chapter -> doc_embedding
        </comment>

        <!-- Add biblioteca_id column -->
        <addColumn tableName="chapter">
            <column name="biblioteca_id" type="INT">
                <constraints nullable="true"/>
            </column>
        </addColumn>

        <!-- Populate biblioteca_id from parent documento -->
        <sql>
            UPDATE chapter c
            SET biblioteca_id = d.biblioteca_id
            FROM documento d
            WHERE c.documento_id = d.id;
        </sql>

        <!-- Make column NOT NULL after populating -->
        <addNotNullConstraint
            tableName="chapter"
            columnName="biblioteca_id"
            columnDataType="INT"/>

        <!-- Add foreign key constraint -->
        <addForeignKeyConstraint
            baseTableName="chapter"
            baseColumnNames="biblioteca_id"
            constraintName="fk_chapter_library"
            referencedTableName="library"
            referencedColumnNames="id"
            onDelete="CASCADE"/>

        <rollback>
            <dropForeignKeyConstraint
                baseTableName="chapter"
                constraintName="fk_chapter_library"/>
            <dropColumn tableName="chapter" columnName="biblioteca_id"/>
        </rollback>
    </changeSet>

</databaseChangeLog>
